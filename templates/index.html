<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArdurTech</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <header>
        <div class="header-left">
            <img src="{{ url_for('static', filename='logo/ardurtech.png') }}" alt="Ardur Technologies" id="companyLogo">
        </div>
        <h4>Data Entry</h4>
        <div class="header-right">
            <div class="dropdown">
                <img src="{{ url_for('static', filename='logo/user.png') }}" alt="User Icon" id="userIcon">
                <span id="username">{{ username }}</span>
                <div class="dropdown-content">
                    <button id="reviewButton" class="dropdown-button">DataEntry Report</button>
                    <button id="logoutButton" class="logout-button">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div>
            <img src="{{ url_for('static', filename='logo/loading.gif') }}" alt="Loading">
            <p>Loading... Please wait</p>
        </div>
    </div>

    <!-- Logout Confirmation Popup -->
    <div id="logoutConfirmation" class="popup-overlay">
        <div class="popup-content">
            <p>Are you sure you want to logout?</p>
            <button id="confirmLogoutButton" class="popup-button">Logout</button>
            <button id="cancelLogoutButton" class="popup-button">Cancel</button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent">
        <div class="container">
            <div id="canvasContainer">
                <div id="browseButtonWrapper">
                    <label for="fileInput" class="choose-file-button">Browse</label>
                    <span id="fileName">No file selected</span>
                </div>
                <input type="file" id="fileInput" style="display: none;"> <!-- Hidden file input -->
                <canvas id="leftCanvas"></canvas>
            </div>
            <div id="rightTextContainer">
                <textarea id="extractedText" readonly></textarea>
            </div>
        </div>

        <div id="sideNav">
            <div class="button-group">
                <button type="button" id="partyButton" onclick="showFields('party')">Party</button>
                <button type="button" id="legalButton" onclick="showFields('legal')">Legal</button>
                <button type="button" id="masterButton" onclick="showFields('master')">Master</button>
                <button type="button" id="submitButton">Submit</button>
            </div>

            <div class="input-fields-container">
            <div id="partyFields" class="input-fields" style="display: none;">
                <div class="input-container">
                    <input type="text" id="grantor" placeholder="Grantor">
                    <button type="button" class="add-button" onclick="addInputField('party', 'grantor')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="grantee" placeholder="Grantee">
                    <button type="button" class="add-button" onclick="addInputField('party', 'grantee')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="comment" placeholder="Comment">
                    <button type="button" class="add-button" onclick="addInputField('party', 'comment')">+</button>
                </div>
            </div>
            
            <div id="legalFields" class="input-fields" style="display: none;">
                <div class="input-container">
                    <input type="text" id="subdivision" placeholder="Subdivision">
                    <button type="button" class="add-button" onclick="addInputField('legal', 'subdivision')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="platnum" placeholder="Platnum">
                    <button type="button" class="add-button" onclick="addInputField('legal', 'platnum')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="lot" placeholder="LOT">
                    <button type="button" class="add-button" onclick="addInputField('legal', 'lot')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="block" placeholder="BLOCK">
                    <button type="button" class="add-button" onclick="addInputField('legal', 'block')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="section" placeholder="SECTION">
                    <button type="button" class="add-button" onclick="addInputField('legal', 'section')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="abstractName" placeholder="ABSTRACT_NAME">
                    <button type="button" class="add-button" onclick="addInputField('legal', 'abstractName')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="abstSvy" placeholder="Abst_svy">
                    <button type="button" class="add-button" onclick="addInputField('legal', 'abstSvy')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="acres" placeholder="Acres">
                    <button type="button" class="add-button" onclick="addInputField('legal', 'acres')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="briefLegal" placeholder="Brief_legal">
                    <button type="button" class="add-button" onclick="addInputField('legal', 'briefLegal')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="refDocs" placeholder="Ref_Docs">
                    <button type="button" class="add-button" onclick="addInputField('legal', 'refDocs')">+</button>
                </div>
            </div>
        
            <div id="masterFields" class="input-fields" style="display: none;">
                <div class="input-container">
                    <input type="text" id="bookType" placeholder="Book_type">
                    <button type="button" class="add-button" onclick="addInputField('master', 'bookType')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="instrumentType" placeholder="Instrument_type">
                    <button type="button" class="add-button" onclick="addInputField('master', 'instrumentType')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="remarks" placeholder="Remarks">
                    <button type="button" class="add-button" onclick="addInputField('master', 'remarks')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="instNo" placeholder="Inst. No.">
                    <button type="button" class="add-button" onclick="addInputField('master', 'instNo')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="caseNo" placeholder="Case_no.">
                    <button type="button" class="add-button" onclick="addInputField('master', 'caseNo')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="volume" placeholder="Volume">
                    <button type="button" class="add-button" onclick="addInputField('master', 'volume')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="page" placeholder="Page">
                    <button type="button" class="add-button" onclick="addInputField('master', 'page')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="instrumentDate" placeholder="Instrument Date">
                    <button type="button" class="add-button" onclick="addInputField('master', 'instrumentDate')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="fillingDate" placeholder="Filling Date">
                    <button type="button" class="add-button" onclick="addInputField('master', 'fillingDate')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="consideration" placeholder="Consideration">
                    <button type="button" class="add-button" onclick="addInputField('master', 'consideration')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="userComment" placeholder="User Comment">
                    <button type="button" class="add-button" onclick="addInputField('master', 'userComment')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="instType" placeholder="Inst Type">
                    <button type="button" class="add-button" onclick="addInputField('master', 'instType')">+</button>
                </div>
                <div class="input-container">
                    <input type="text" id="recordType" placeholder="Record type">
                    <button type="button" class="add-button" onclick="addInputField('master', 'recordType')">+</button>
                </div>
            </div>
            </div>
        

        <script>
            let scale = 1;
            let originX = 0;
            let originY = 0;
            let isDragging = false;
            let lastX, lastY;
            let imgWidth, imgHeight;
            let imageObj;
            let filepath = '';

            function addInputField(section, id) {
            const inputContainer = document.createElement('div');
            inputContainer.className = 'input-container';
            
            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.placeholder = document.getElementById(id).placeholder;

            const addButton = document.createElement('button');
            addButton.type = 'button';
            addButton.className = 'add-button';
            addButton.textContent = '+';
            addButton.onclick = function() {
                addInputField(section, id);
            };

            inputContainer.appendChild(newInput);
            inputContainer.appendChild(addButton);

            document.getElementById(`${section}Fields`).appendChild(inputContainer);

            // Add event listener for formatting on the new input field
            newInput.addEventListener('input', function() {
                const selectedText = window.getSelection().toString();
                if (selectedText) {
                    const cleanedText = selectedText.replace(/[^a-zA-Z\s]/g, ' ').trim(); // Remove special characters
                    const nameParts = cleanedText.split(/\s+/);

                    if (nameParts.length >= 2) {
                        const firstName = nameParts[0];
                        const lastName = nameParts[nameParts.length - 1];
                        const middleName = nameParts.slice(1, nameParts.length - 1).join(' ');

                        const formattedName = `${lastName} ${firstName} ${middleName}`.trim(); // Format to "lastname firstname middle name"
                        newInput.value = formattedName;
                    } else {
                        newInput.value = cleanedText; // Fallback
                    }
                }
            });
        }


        function showFields(section) {
            document.querySelectorAll('.input-fields').forEach(div => div.style.display = 'none');
            document.getElementById(`${section}Fields`).style.display = 'block';
        }

            document.getElementById('fileInput').addEventListener('change', function (event) {
                document.getElementById('loadingOverlay').style.display = 'flex';
                document.getElementById('mainContent').classList.add('blur-background');

                const file = event.target.files[0];
                const formData = new FormData();
                formData.append('file', file);

                document.getElementById('fileName').textContent = file.name;

                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('extractedText').value = data.text;
                        document.getElementById('loadingOverlay').style.display = 'none';
                        document.getElementById('mainContent').classList.remove('blur-background');

                        if (data.error) {
                            alert(data.error);
                        } else {
                            const leftCanvas = document.getElementById('leftCanvas');
                            const ctxLeft = leftCanvas.getContext('2d');
                            imageObj = new Image();

                            imageObj.onload = function () {
                                imgWidth = imageObj.width;
                                imgHeight = imageObj.height;
                                leftCanvas.width = imgWidth;
                                leftCanvas.height = imgHeight;
                                ctxLeft.drawImage(imageObj, 0, 0);
                            };
                            imageObj.src = 'data:image/png;base64,' + data.image;
                            filepath = data.filepath;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error uploading file');
                    });
            });

            function showFields(type) {
                document.querySelectorAll('.input-fields').forEach(function (fieldSet) {
                    fieldSet.style.display = 'none';
                });

                if (type === 'party') {
                    document.getElementById('partyFields').style.display = 'block';
                } else if (type === 'legal') {
                    document.getElementById('legalFields').style.display = 'block';
                } else if (type === 'master') {
                    document.getElementById('masterFields').style.display = 'block';
                }

                checkInputsFilled();
            }

            function checkInputsFilled() {
                const inputs = document.querySelectorAll('#sideNav input[type="text"]');
                let anyFieldFilled = false;

                for (let input of inputs) {
                    if (input.value) {
                        anyFieldFilled = true;
                        break;
                    }
                }

                document.getElementById('submitButton').disabled = !anyFieldFilled;
            }

            document.getElementById('submitButton').addEventListener('click', function () {
                const selectedSection = document.querySelector('#sideNav .input-fields[style*="display: block"]').id.replace('Fields', '');
                const inputs = document.querySelectorAll(`#${selectedSection}Fields input[type="text"]`);
                const data = {
                    selectedSection: selectedSection,
                    filePath: filepath,
                    username: '{{ username }}'
                };

                inputs.forEach(input => {
                    data[input.id] = input.value;
                });

                fetch('/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Submission successful!');
                            inputs.forEach(input => {
                                input.value = '';
                            });
                            document.getElementById('submitButton').disabled = true;
                        } else {
                            alert(data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error submitting data');
                    });
            });
            document.querySelectorAll('#sideNav input[type="text"]').forEach(function (input) {
            input.addEventListener('input', function() {
                const selectedText = window.getSelection().toString();
                if (selectedText && document.activeElement === document.getElementById('grantor')) {
                    const cleanedText = selectedText.replace(/[^a-zA-Z\s]/g, ' ').trim(); // Remove special characters
                    const nameParts = cleanedText.split(/\s+/);

                    if (nameParts.length >= 2) {
                        const firstName = nameParts[0];
                        const lastName = nameParts[nameParts.length - 1];
                        const middleName = nameParts.slice(1, nameParts.length - 1).join(' ');

                        const formattedName = `${lastName} ${firstName} ${middleName}`.trim(); // Format to "lastname firstname middle name"
                        input.value = formattedName;
                    } else {
                        input.value = cleanedText; // Fallback
                    }
                }
            });
        });

            document.querySelectorAll('#sideNav input[type="text"]').forEach(function (input) {
                input.addEventListener('input', checkInputsFilled);
            });

            document.getElementById('logoutButton').addEventListener('click', function () {
                document.getElementById('logoutConfirmation').style.display = 'block';
            });

            document.getElementById('confirmLogoutButton').addEventListener('click', function () {
                window.location.href = '/logout';
            });
            document.getElementById('cancelLogoutButton').addEventListener('click', function () {
                document.getElementById('logoutConfirmation').style.display = 'none';
            });

            const leftCanvas = document.getElementById('leftCanvas');
            leftCanvas.addEventListener('mousedown', function (e) {
                isDragging = true;
                lastX = e.offsetX;
                lastY = e.offsetY;
            });

            leftCanvas.addEventListener('mousemove', function (e) {
                if (isDragging) {
                    const dx = e.offsetX - lastX;
                    const dy = e.offsetY - lastY;
                    originX += dx;
                    originY += dy;
                    lastX = e.offsetX;
                    lastY = e.offsetY;
                    drawCanvas();
                }
            });

            leftCanvas.addEventListener('mouseup', function () {
                isDragging = false;
            });

            leftCanvas.addEventListener('mouseleave', function () {
                isDragging = false;
            });

            leftCanvas.addEventListener('wheel', function (e) {
                e.preventDefault();
                scale += e.deltaY * -0.001;
                scale = Math.min(Math.max(0.5, scale), 4);
                drawCanvas();
            });

            function drawCanvas() {
                const ctxLeft = leftCanvas.getContext('2d');
                ctxLeft.clearRect(0, 0, leftCanvas.width, leftCanvas.height);
                ctxLeft.drawImage(imageObj, originX, originY, imgWidth * scale, imgHeight * scale);
            }
        </script>
    </div>
</body>

</html>
